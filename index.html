<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Insta Vault - Offline</title>
    <link rel="manifest" href="manifest.json">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .reel-card:hover { transform: translateY(-5px); transition: 0.3s; }
        body { background-color: #050505; font-family: sans-serif; }
    </style>
</head>
<body class="text-white p-5">

    <div class="max-w-md mx-auto">
        <h1 class="text-3xl font-bold text-pink-500 mb-2">Insta Vault üì¶</h1>
        <p class="text-gray-400 text-sm mb-6">Links save cheyi, offline lo chusko!</p>

        <div class="flex gap-2 mb-8 bg-zinc-900 p-2 rounded-2xl border border-zinc-800">
            <input id="instaUrl" type="text" placeholder="Paste link mama..." 
                   class="bg-transparent flex-1 p-2 outline-none text-sm">
            <button id="saveBtn" onclick="saveReel()" class="bg-pink-600 px-4 py-2 rounded-xl font-bold">Save</button>
        </div>

        <div id="vaultGrid" class="grid grid-cols-1 gap-4">
            </div>
    </div>

    <script>
        // 1. Database Setup
        const dbName = "InstaVaultDB";
        let db;
        const request = indexedDB.open(dbName, 1);

        request.onupgradeneeded = e => {
            db = e.target.result;
            db.createObjectStore("videos", { keyPath: "id" });
        };
        request.onsuccess = e => { 
            db = e.target.result; 
            renderReels(); 
        };

        // 2. Save Reel Logic
        async function saveReel() {
    const url = document.getElementById('instaUrl').value;
    const btn = document.getElementById('saveBtn');
    if(!url) return alert("Link pettu mama!");

    btn.innerText = "Downloading...";
    btn.disabled = true;

    try {
        // Manam download chesthunna file real video file ayyi undali.
        // Instagram URL ni direct ga fetch cheyalem, so let's use a better proxy or fallback.
        const response = await fetch(`https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`);
        
        if (!response.ok) throw new Error("Network issues mama!");

        const blob = await response.blob();

        // Blob size check - 0 bytes unte block ayyinattu
        if (blob.size < 100) {
            throw new Error("Instagram blocked us!");
        }

        const newReel = {
            id: Date.now(),
            url: url,
            videoBlob: blob,
            type: 'offline'
        };

        const transaction = db.transaction("videos", "readwrite");
        transaction.objectStore("videos").add(newReel);
        
        transaction.oncomplete = () => {
            btn.innerText = "Save";
            btn.disabled = false;
            document.getElementById('instaUrl').value = '';
            renderReels();
        };
    } catch (err) {
        console.log("Offline fail: ", err);
        alert("Instagram block chesindi mama, andhuke play avvatledhu. Embed mode lo save chesthunna!");
        saveAsEmbed(url); // Ikkada embed mode ki switch chesthunnam
    }
}

        function saveAsEmbed(url) {
            let embeds = JSON.parse(localStorage.getItem('embedVault')) || [];
            embeds.push({ id: Date.now(), url: url, type: 'embed' });
            localStorage.setItem('embedVault', JSON.stringify(embeds));
            
            document.getElementById('saveBtn').innerText = "Save";
            document.getElementById('saveBtn').disabled = false;
            document.getElementById('instaUrl').value = '';
            renderReels();
        }

        // 3. Main Render Function
        function renderReels() {
            const grid = document.getElementById('vaultGrid');
            grid.innerHTML = '';

            // A. IndexedDB nundi Offline Videos
            const transaction = db.transaction("videos", "readonly");
            const store = transaction.objectStore("videos");
            
            store.openCursor(null, 'prev').onsuccess = (e) => {
                const cursor = e.target.result;
                if (cursor) {
                    const reel = cursor.value;
                    const videoUrl = URL.createObjectURL(reel.videoBlob);
                    createCard(reel.url, videoUrl, true);
                    cursor.continue();
                }
            };

            // B. LocalStorage nundi Embeds
            const embeds = JSON.parse(localStorage.getItem('embedVault')) || [];
            embeds.reverse().forEach(reel => {
                const instaId = reel.url.split('/reels/')[1] || reel.url.split('/p/')[1] || reel.url.split('/reel/')[1];
                const cleanId = instaId ? instaId.split('/')[0] : '';
                const embedUrl = `https://www.instagram.com/p/${cleanId}/embed`;
                createCard(reel.url, embedUrl, false);
            });
        }

        function createCard(originalUrl, displayUrl, isOffline) {
            const grid = document.getElementById('vaultGrid');
            const card = document.createElement('div');
            card.className = "reel-card mb-4 bg-zinc-900 rounded-2xl overflow-hidden border border-zinc-800 p-2";
            
            if(isOffline) {
                card.innerHTML = `
                    <video src="${displayUrl}" controls class="w-full rounded-xl"></video>
                    <div class="flex justify-between items-center p-2">
                        <p class="text-[10px] text-gray-500 truncate w-3/4">${originalUrl}</p>
                        <span class="text-[9px] text-green-500 font-bold">OFFLINE ‚úÖ</span>
                    </div>
                `;
            } else {
                card.innerHTML = `
                    <iframe src="${displayUrl}" class="w-full h-[450px]" frameborder="0" scrolling="no"></iframe>
                    <div class="flex justify-between items-center p-2">
                        <p class="text-[10px] text-gray-500 truncate w-3/4">${originalUrl}</p>
                        <span class="text-[9px] text-blue-500 font-bold">ONLINE ONLY üåê</span>
                    </div>
                `;
            }
            grid.appendChild(card);
        }

        // Service Worker
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js');
        }
    </script>
</body>
</html>
