<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Personal Vault - Pure Offline</title>
    <link rel="manifest" href="manifest.json">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .reel-card { transition: 0.3s; }
        body { background-color: #050505; color: white; font-family: sans-serif; }
    </style>
</head>
<body class="p-5">

    <div class="max-w-md mx-auto">
        <h1 class="text-3xl font-bold text-pink-500 mb-2">My Offline Vault ðŸ“¦</h1>
        <p class="text-gray-400 text-sm mb-6">Net lekunda chusko mama!</p>

        <div class="flex gap-2 mb-8 bg-zinc-900 p-2 rounded-2xl border border-zinc-800">
            <input id="socialUrl" type="text" placeholder="Paste link (Insta/Twitter)..." 
                   class="bg-transparent flex-1 p-2 outline-none text-sm">
            <button id="saveBtn" onclick="processVideo()" class="bg-pink-600 px-4 py-2 rounded-xl font-bold">Save</button>
        </div>

        <div id="vaultGrid" class="flex flex-col gap-6">
            </div>
    </div>

    <script>
        let db;
        const request = indexedDB.open("PersonalVault", 1);

        request.onupgradeneeded = e => {
            db = e.target.result;
            db.createObjectStore("media", { keyPath: "id" });
        };
        request.onsuccess = e => { db = e.target.result; renderVault(); };

        async function processVideo() {
            const url = document.getElementById('socialUrl').value;
            const btn = document.getElementById('saveBtn');
            if(!url) return;

            btn.innerText = "Downloading...";
            btn.disabled = true;

            try {
                // IMPORTANT: Ee URL daggara nee Vercel App URL pettu mama
                // Temporary ga 'allorigins' vaduthunnam, but Vercel setup chesthe stable untundi
                const proxyUrl = `https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`;
                
                const response = await fetch(proxyUrl);
                const blob = await response.blob();

                if(blob.size < 1000) throw new Error("File too small - Blocked!");

                const entry = {
                    id: Date.now(),
                    url: url,
                    data: blob,
                    time: new Date().toLocaleTimeString()
                };

                const tx = db.transaction("media", "readwrite");
                tx.objectStore("media").add(entry);
                tx.oncomplete = () => {
                    btn.innerText = "Save";
                    btn.disabled = false;
                    document.getElementById('socialUrl').value = '';
                    renderVault();
                };
            } catch (err) {
                alert("Direct download blocked mama! Check internet or Proxy.");
                btn.innerText = "Save";
                btn.disabled = false;
            }
        }

        function renderVault() {
            const grid = document.getElementById('vaultGrid');
            grid.innerHTML = '';
            
            const tx = db.transaction("media", "readonly");
            const store = tx.objectStore("media");
            
            store.openCursor(null, 'prev').onsuccess = (e) => {
                const cursor = e.target.result;
                if (cursor) {
                    const item = cursor.value;
                    const videoUrl = URL.createObjectURL(item.data);
                    
                    const card = document.createElement('div');
                    card.className = "bg-zinc-900 rounded-3xl overflow-hidden border border-zinc-800 shadow-xl";
                    card.innerHTML = `
                        <video src="${videoUrl}" controls class="w-full h-auto max-h-[500px]"></video>
                        <div class="p-4 bg-zinc-900/50 backdrop-blur">
                            <p class="text-[10px] text-zinc-500 truncate mb-1">${item.url}</p>
                            <span class="text-[9px] bg-green-500/20 text-green-400 px-2 py-1 rounded-full font-bold">READY OFFLINE âœ…</span>
                        </div>
                    `;
                    grid.appendChild(card);
                    cursor.continue();
                }
            };
        }
    </script>
</body>
</html>
