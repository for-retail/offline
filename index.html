<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Universal Media Vault ðŸ“¦</title>
    <link rel="manifest" href="manifest.json">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background-color: #050505; color: white; font-family: sans-serif; }
        .media-card { background: #111; border-radius: 20px; overflow: hidden; border: 1px solid #222; }
        img, video { width: 100%; height: auto; display: block; }
    </style>
</head>
<body class="p-5">

    <div class="max-w-md mx-auto">
        <h1 class="text-3xl font-bold text-pink-500 mb-2">Media Vault ðŸ“¦</h1>
        <p class="text-gray-400 text-sm mb-6">Video, Photo edhaina dachey mama!</p>

        <div class="flex flex-col gap-3 mb-8 bg-zinc-900 p-4 rounded-3xl border border-zinc-800 shadow-2xl">
            <input id="mediaUrl" type="text" placeholder="Paste Video or Image link..." 
                   class="bg-zinc-800 p-3 rounded-xl outline-none text-sm border border-zinc-700 focus:border-pink-500 transition">
            <button id="saveBtn" onclick="processMedia()" class="bg-pink-600 p-3 rounded-xl font-bold active:scale-95 transition">
                Add to Vault
            </button>
        </div>

        <div id="vaultGrid" class="flex flex-col gap-6">
            </div>
    </div>

    <script>
        let db;
        const request = indexedDB.open("UniversalMediaVault", 1);

        request.onupgradeneeded = e => {
            db = e.target.result;
            db.createObjectStore("media", { keyPath: "id" });
        };

        request.onsuccess = e => { db = e.target.result; renderVault(); };

        async function processMedia() {
            const url = document.getElementById('mediaUrl').value;
            const btn = document.getElementById('saveBtn');
            if(!url) return;

            btn.innerText = "Downloading...";
            btn.disabled = true;

            try {
                const response = await fetch(url);
                const blob = await response.blob();
                
                // File type ni identify chesthunnam (image-ah leka video-ah)
                const fileType = blob.type; 

                const entry = {
                    id: Date.now(),
                    data: blob,
                    url: url,
                    mime: fileType,
                    date: new Date().toLocaleDateString()
                };

                const tx = db.transaction("media", "readwrite");
                tx.objectStore("media").add(entry);
                tx.oncomplete = () => {
                    finalize();
                };
            } catch (err) {
                alert("Direct download blocked! CORS issue valla image/video dachalekapothunna. Link direct file dhi ayyi undali mama.");
                finalize();
            }
        }

        function finalize() {
            const btn = document.getElementById('saveBtn');
            btn.innerText = "Add to Vault";
            btn.disabled = false;
            document.getElementById('mediaUrl').value = '';
            renderVault();
        }

        function renderVault() {
            const grid = document.getElementById('vaultGrid');
            grid.innerHTML = '';
            
            const tx = db.transaction("media", "readonly");
            tx.objectStore("media").openCursor(null, 'prev').onsuccess = (e) => {
                const cursor = e.target.result;
                if (cursor) {
                    const item = cursor.value;
                    const blobUrl = URL.createObjectURL(item.data);
                    
                    const card = document.createElement('div');
                    card.className = "media-card shadow-xl";
                    
                    // Logic: Image ayithe <img> tag, Video ayithe <video> tag
                    let mediaElement = '';
                    if (item.mime.startsWith('image/')) {
                        mediaElement = `<img src="${blobUrl}" alt="Saved Image">`;
                    } else {
                        mediaElement = `<video src="${blobUrl}" controls preload="metadata"></video>`;
                    }

                    card.innerHTML = `
                        ${mediaElement}
                        <div class="p-4 flex justify-between items-center bg-zinc-900">
                            <span class="text-[10px] text-zinc-500 font-mono">${item.mime.split('/')[1].toUpperCase()} File</span>
                            <span class="text-[10px] text-green-500 font-bold">OFFLINE READY âœ…</span>
                        </div>
                    `;
                    grid.appendChild(card);
                    cursor.continue();
                }
            };
        }
    </script>
</body>
</html>
